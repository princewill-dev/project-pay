{% extends 'home/main.html' %}

{% load static %}

{% block content %}

<!-- {% include 'home/navbar.html' %}
  
{% include 'home/mobile-nav.html' %} -->

{% include 'home/mobile-sidebar.html' %}

<!--===== WELCOME STARTS =======-->

<div class="about-welcome-section-area login" style="background-image: url(/static/onboarding/assets/images/background/emailbg.png); background-repeat: no-repeat; background-size: cover;">
    <div class="container">
        <div class="row">
            <div class="col-lg-6 m-auto">
                <div class="about-welcome-header text-center heading3">
                    <span class="text-white">Complete your purchase on <br> {{user_info.tag_name}}</span>
                </div>

                <div class="login-boxarea heading6">

                    <p class="text-center" id="amount">Amount: {{transaction_details.amount}} {{user_info.crypto}}</p>

                    <center>
                        <img id="wallet_qrcode_image" src="{{ user_info.qr_code_image }}" alt="QR Code">
                        <img id="success_image" src="/static/onboarding/assets/images/icons/success_icon.png" width="150px" alt="success" style="display: none;">
                    </center>

                    <p class="text-center" id="success_message" style="font-size: 16px; display: none;">Yayy! Payment confirmed</p>

                    <p class="text-center" id="network">Network: {{user_info.crypto}}</p>

                    <p class="text-center" id="wallet" style="font-size: 12px;">{{user_info.wallet}}</p>

                    <p class="text-center" id="transaction_amount" style="font-size: 12px; display: none;"></p>

                    <!-- <p class="text-center" id="transaction_hash" style="font-size: 12px; display: none;"></p> -->

                    <!-- <a href="https://tronscan.org/#/transaction/"></a> -->

                    <p class="text-center" id="transaction_confirmed" style="font-size: 12px; display: none;"></p>

                    <div class="text-center">
                        <img id="pending_image" src="/static/onboarding/assets/images/icons/pending_icon.webp" alt="pending" width="30px">
                    </div>

                    <p class="text-center" id="redirect_to_store" style="font-size: 12px; display: none;">redirecting to store <span id="redirect_counter"></span></p>

                    <br>
                    <p class="text-center" id="success_message" style="font-size: 16px;">powered by <a href="bitwade.com" target="_blank">bitwade.com</a></p>

                </div>

                <script>
                    const QrCodeImage = document.getElementById('wallet_qrcode_image');
                    const successImage = document.getElementById('success_image');
                    const transactionAmount = document.getElementById('transaction_amount');
                    // const transactionHash = document.getElementById('transaction_hash');
                    const transactionConfirmed = document.getElementById('transaction_confirmed');
                    const loadingImage = document.getElementById('pending_image');

                    const successMessage = document.getElementById('success_message');

                    const txNetwork = document.getElementById('network');
                    const txWallet = document.getElementById('wallet');
                    const txAmount = document.getElementById('amount');

                    const redirectMessage = document.getElementById('redirect_to_store');
                    const redirectCounterElement = document.getElementById('redirect_counter');
                
                    function getTransactionDetails() {
                        fetch('/api/get_transaction_details/{{transaction_details.transaction_id}}')
                            .then(response => response.json())
                            .then(data => {
                                if (data.hash) {
                                    // Update the transaction details on the page
                                    QrCodeImage.style.display = 'none';
                                    successImage.style.display = 'block';
                                    transactionAmount.style.display = 'block';
                                    transactionConfirmed.style.display = 'block';
                                    loadingImage.style.display = 'none';
                                    transactionAmount.textContent = 'Amount: ' + data.amount / 1000000 + ' TRX';

                                    txNetwork.style.display = 'none';
                                    txWallet.style.display = 'none';
                                    txAmount.style.display = 'none';

                                    successMessage.style.display = 'block';

                                    redirectMessage.style.display = 'block';
                                    let counter = 5;
                                    redirectCounterElement.textContent = counter;
                                    const intervalId = setInterval(() => {
                                        counter--;
                                        redirectCounterElement.textContent = counter;
                                        if (counter === 0) {
                                            clearInterval(intervalId);
                                        }
                                    }, 1000);

                                    // Redirect to the new URL after 5 seconds
                                    setTimeout(() => {
                                        window.location.href = window.location.origin + '/store/success/';
                                    }, 5000);
                                }

                                // Call the function again after a delay of 5 seconds
                                setTimeout(getTransactionDetails, 5000);
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                setTimeout(getTransactionDetails, 5000);
                            });
                    }
                
                    // Start checking for the transaction
                    getTransactionDetails();
                </script>
                
            </div>
        </div>
    </div>
</div>
<!--===== WELCOME ENDS =======-->


{% endblock %}