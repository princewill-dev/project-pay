{% extends 'home/main.html' %}

{% load static %}

{% block content %}

<!--===== WELCOME STARTS =======-->

<div class="about-welcome-section-area login" style="background-image: url(/static/onboarding/assets/images/background/emailbg.png); background-repeat: no-repeat; background-size: cover;">
    <div class="container">
        <div class="row">
            <div class="col-lg-4 m-auto">

                <div id="on_load">

                    <div class="login-boxarea heading6">
                        <!-- <h3 style="display: none;">
                            {% if transaction_details.link_logo %}
                                <img src="{{ transaction_details.link_logo.url }}" alt="" width="50px" height="50px" style="border-radius: 3px; border: 2px solid #000;">
                            {% else %}
                                <img src="/static/onboarding/assets/images/elements/store-checkout.png" alt="store-logo" width="50px">
                            {% endif %}
                            {{transaction_details.tag_name}}
                        </h3> -->
    
                        <div class="text-center" id="items_to_remove">
                            
                            <h3 class="text-center addamount"></h3>
                            <script type="text/javascript">
                                var amount = parseFloat('{{ transaction_details.amount }}');
                                var charges = parseFloat('{{ transaction_details.charges }}');
                                var total = amount + charges;
                            
                                window.onload = function() {
                                    document.querySelector('.addamount').textContent = '$' + total.toFixed(2);
                                }
                            </script>

                            <p class="text-center" style="font-size: 10px;">Amount: ${{transaction_details.amount}} | Processing fee: ${{transaction_details.charges}}</p>
                            <hr>
                            <p class="text-center">Please send exactly <span style="color: blue;">{{transaction_details.converted_amount}}</span> {{transaction_details.crypto_network}}</p>

                        </div>                    
    
                        <div class="space16"></div>
                        
                        <center>
                            <img id="wallet_qrcode_image" src="/mediafiles/qr_codes/{{transaction_details.qr_code}}" alt="QR Code" width="180px" style="border-radius: 5px; border: 2px solid #000;">
                        </center>
    
                        <div class="space16"></div>

                        <p class="text-center" style="font-size: 12px;">{{transaction_details.wallet}}</p>

                        <div class="space16"></div>
    
                        <p class="text-center" id="network">
                            Crypto: {{transaction_details.crypto_network}} 
                            <a href="{% url 'select_transaction_crypto' transaction_details.transaction_id %}" >change crypto?</a>
                        </p>


                        <hr>
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
                        <p class="text-center">Time left: <span id="countdown" class="countdown"></span></p>

                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                // Get the time difference from the template context
                                var timeDifference = {{ transaction_details.time_difference }};
                    
                                function updateCountdown() {
                                    if (timeDifference <= 0) {
                                        document.getElementById('countdown').innerHTML = "Time's up!";
                                    } else {
                                        var minutes = Math.floor(timeDifference / 60);
                                        var seconds = timeDifference % 60;
                                        document.getElementById('countdown').innerHTML = minutes + 'm ' + seconds + 's ';
                                        timeDifference--;  // Decrease the time difference by one second
                                    }
                                }
                    
                                // Update the countdown every second
                                setInterval(updateCountdown, 1000);
                                updateCountdown(); // Initial call to display the countdown immediately
                            });
                        </script>

                        <p class="text-center">
                            checking for transaction
                            <img src="/static/onboarding/assets/images/icons/pending_icon.webp" alt="pending" width="20px">
                        </p>

                    </div>

                    <div class="space16"></div>

                    <div class="text-center" id="items_to_remove">
                        <a href="#" id="items_to_remove" style="font-size: 12px; background: #cc1313; color: #fff; padding: 10px; border-radius: 5px; margin: 5px;" onclick="return confirm('Cancel Transaction ?');">cancel transaction</a>
                    </div>

                    <div class="space16"></div>

                    <p class="text-center text-white" id="success_message" style="font-size: 16px;">powered by <a href="bixmerchant.com" target="_blank">bixmerchant.com</a></p>

                </div>

                <div id="on_success" style="display: none;">

                    <div class="login-boxarea heading6">

                        <center>
                            <img src="/static/onboarding/assets/images/icons/success_icon.png" width="150px" alt="success">
                        </center>
    
                        <div class="space32"></div>
                        <h3 class="text-center"> Payment Succesful ðŸŽ‰ </h3>
                        <div class="space16"></div>                
                        
                        <p class="text-center">Merchant: {{ transaction_details.tag_name }}</p>
    
                        <p class="text-center">{{ transaction_details.amount }} {{transaction_details.crypto_network}}</p>
    
                        <p class="text-center">TxID: {{ transaction_details.transaction_id }}</p>
    
                        <p class="text-center" id="success_message" style="font-size: 16px;"> <a href="{{ transaction_details.hash }}" target="_blank">view on blockchain</a></p>

                        <hr>
                        <p class="text-center" id="success_message" style="font-size: 16px;">powered by <a href="bixmerchant.com" target="_blank">bixmerchant.com</a></p>

                    </div>

                    <div class="space16"></div>

                    <div class="text-center" id="items_to_remove">
                        <a href="#" id="items_to_remove" style="font-size: 16px; background: #134ecc; color: #fff; padding: 10px; border-radius: 5px; margin: 5px;">Back to merchant</a>
                    </div>

                </div>

                <div id="on_error" style="display: none;">

                    <div class="login-boxarea heading6">

                        <center>
                            <img src="/static/onboarding/assets/images/icons/error_icon.png" width="100px" alt="error">
                        </center>
    
                        <div class="space32"></div>
                        <h6 class="text-center" id="error_message"></h6>
                        <div class="space16"></div>                
                        

                        <hr>
                        <p class="text-center" style="font-size: 16px;">powered by <a href="bixmerchant.com" target="_blank">bixmerchant.com</a></p>

                    </div>

                    <div class="space16"></div>

                    <div class="text-center" id="items_to_remove">
                        <a href="#" id="items_to_remove" style="font-size: 16px; background: #134ecc; color: #fff; padding: 10px; border-radius: 5px; margin: 5px;">Back to merchant</a>
                    </div>

                </div>

            </div> 

            <script>
                const onLoad = document.getElementById('on_load');
                const onSuccess = document.getElementById('on_success');
                const onError = document.getElementById('on_error');
                const errorMessage = document.getElementById('error_message');

                function getTransactionDetails() {
                    fetch('/api/v1/find-tx/{{transaction_details.transaction_id}}')
                        .then(response => {
                            console.log('Response:', response); // Todo: remove this line
                            return response.json().then(data => ({ status: response.status, body: data }));
                        })
                        .then(result => {
                            console.log('Data:', result.body);
                            if (result.body.transaction_status === "successful") {
                                onLoad.style.display = 'none';
                                onSuccess.style.display = 'block';
                            } else if (result.body.status === "expired") {
                                onLoad.style.display = 'none';
                                onError.style.display = 'block';
                                errorMessage.textContent = result.body.message;
                            } else {
                                setTimeout(getTransactionDetails, 5000);
                            }
                        })
                        // .catch(error => {
                        //     console.error('Error:', error);
                        //     onLoad.style.display = 'none';
                        //     onError.style.display = 'block';
                        //     errorMessage.textContent = 'An error occurred';
                        // });
                }

                // Start checking for the transaction
                getTransactionDetails();
            </script>
            
        </div>
    </div>
</div>
<!--===== WELCOME ENDS =======-->

{% endblock %}
