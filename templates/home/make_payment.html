{% extends 'home/main.html' %}

{% load static %}

{% block content %}


<!--===== WELCOME STARTS =======-->

<div class="about-welcome-section-area login" style="background-image: url(/static/onboarding/assets/images/background/emailbg.png); background-repeat: no-repeat; background-size: cover;">
    <div class="container">
        <div class="row">
            <div class="col-lg-4 m-auto">

                <div id="on_load">

                    <div class="login-boxarea heading6">
                        <h3>
                            {% if transaction_details.link_logo %}
                                <img src="{{ transaction_details.link_logo.url }}" alt="" width="50px" height="50px" style="border-radius: 3px; border: 2px solid #000;">
                            {% else %}
                                <img src="/static/onboarding/assets/images/elements/store-checkout.png" alt="store-logo" width="50px">
                            {% endif %}
                            {{transaction_details.tag_name}}
                        </h3>
    
                        <div class="text-center" id="items_to_remove">
                            <p class="text-center">
                                checking for transaction
                                <img src="/static/onboarding/assets/images/icons/pending_icon.webp" alt="pending" width="20px">
                            </p>
                            
                            <hr>
                            
                            <h3 class="text-center addamount"></h3>
                            <script type="text/javascript">
                                var amount = parseFloat('{{ transaction_details.amount }}');
                                var charges = parseFloat('{{ transaction_details.charges }}');
                                var total = amount + charges;
                            
                                window.onload = function() {
                                    document.querySelector('.addamount').textContent = '$' + total.toFixed(2);
                                }
                            </script>

                            <p class="text-center" style="font-size: 10px;">Amount: ${{transaction_details.amount}} | Processing fee: ${{transaction_details.charges}}</p>
                            <hr>
                            <p class="text-center">Please send exactly <span style="color: blue;">{{transaction_details.converted_amount}}</span> {{transaction_details.crypto_network}}</p>
                        </div>                    
    
                        <div class="space16"></div>
                        
                        <center>
                            <img id="wallet_qrcode_image" src="/mediafiles/qr_codes/{{transaction_details.qr_code}}" alt="QR Code" width="180px" style="border-radius: 5px; border: 2px solid #000;">
                        </center>
    
                        <div class="space16"></div>

                        <p class="text-center" style="font-size: 12px;">{{transaction_details.wallet}}</p>

                        <div class="space16"></div>
    
                        <p class="text-center" id="network">
                            Crypto: {{transaction_details.crypto_network}} 
                            <a href="{% url 'select_transaction_crypto' transaction_details.transaction_id %}" >change crypto?</a>
                        </p>

                        <hr>
                        <p class="text-center" id="success_message" style="font-size: 16px;">powered by <a href="bitwade.com" target="_blank">bitwade.com</a></p>

                    </div>

                    <div class="space16"></div>

                    <div class="text-center" id="items_to_remove">
                        <a href="#" id="items_to_remove" style="font-size: 12px; background: #cc1313; color: #fff; padding: 10px; border-radius: 5px; margin: 5px;" onclick="return confirm('Cancel Transaction ?');">cancel transaction</a>
                    </div>

                </div>

                <div id="on_success" style="display: none;">

                    <div class="login-boxarea heading6">

                        <center>
                            <img src="/static/onboarding/assets/images/icons/success_icon.png" width="150px" alt="success">
                        </center>
    
                        <div class="space32"></div>
                        <h3 class="text-center"> Payment Succesful ðŸŽ‰ </h3>
                        <div class="space16"></div>                
                        
                        <p class="text-center">Merchant: {{ transaction_details.tag_name }}</p>
    
                        <p class="text-center">{{ transaction_details.amount }} {{transaction_details.crypto_network}}</p>
    
                        <p class="text-center">TxID: {{ transaction_details.transaction_id }}</p>
    
                        <p class="text-center" id="success_message" style="font-size: 16px;"> <a href="{{ transaction_details.hash }}" target="_blank">view on blockchain</a></p>

                        <hr>
                        <p class="text-center" id="success_message" style="font-size: 16px;">powered by <a href="bitwade.com" target="_blank">bitwade.com</a></p>

                    </div>

                    <div class="space16"></div>

                    <div class="text-center" id="items_to_remove">
                        <a href="#" id="items_to_remove" style="font-size: 16px; background: #134ecc; color: #fff; padding: 10px; border-radius: 5px; margin: 5px;">Back to merchant</a>
                    </div>

                </div>

            </div> 

            <script>

                const onLoad = document.getElementById('on_load');
                const onSuccess = document.getElementById('on_success');
            
                function getTransactionDetails() {
                    fetch('/api/v1/find-tx/{{transaction_details.transaction_id}}')
                        // .then(response => response.json())
                        .then(response => {
                            console.log('Response:', response);
                            return response.json();
                        })
                        .then(data => {
                            console.log('Data:', data);
                            if (data.confirmed === true) {
                                // Update the transaction details on the page
                                // transactionAmount.textContent = 'Amount: ' + data.amount / 1000000 + ' {{transaction_details.crypto_network}}';
                                onLoad.style.display = 'none';
                                onSuccess.style.display = 'block';
                            }
                            // Call the function again after a delay of 5 seconds
                            setTimeout(getTransactionDetails, 5000);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            setTimeout(getTransactionDetails, 5000);
                        });
                }
                // Start checking for the transaction
                getTransactionDetails();

            </script>
            
        </div>
    </div>
</div>
<!--===== WELCOME ENDS =======-->


{% endblock %}