{% extends 'home/main.html' %}

{% load static %}

{% block content %}


<!--===== WELCOME STARTS =======-->

<div class="about-welcome-section-area login" style="background-image: url(/static/onboarding/assets/images/background/emailbg.png); background-repeat: no-repeat; background-size: cover;">
    <div class="container">
        <div class="row">
            <div class="col-lg-4 m-auto">
                <div class="about-welcome-header text-center heading3">
                    <span class="text-white">{{transaction_details.tag_name}}</span>
                </div>

                <br>

                <div class="login-boxarea heading6">

                    <div class="text-center" id="items_to_remove">
                        <p class="text-center">
                            checking for transaction
                            <img src="/static/onboarding/assets/images/icons/pending_icon.webp" alt="pending" width="20px">
                        </p>
                        <hr>
                        <p class="text-center">Amount: ${{transaction_details.amount}}</p>
                        <p class="text-center">Please send exactly <span style="color: blue;">{{transaction_details.converted_amount}}</span> {{transaction_details.crypto_network}}</p>
                    </div>

                    

                    <!-- <p class="text-center" id="amount">Please pay to the merchant's wallet addresses below</p> -->

                    

                    <div class="space16"></div>
                    
                    <center>
                        <img id="wallet_qrcode_image" src="/static/images/{{ transaction_details.qr_code }}" alt="QR Code" width="150px" style="border-radius: 5px; border: 2px solid #000;">
                        <img id="success_image" src="/static/onboarding/assets/images/icons/success_icon.png" width="150px" alt="success" style="display: none;">
                    </center>

                    <div class="space16"></div>
                    
                    <p class="text-center" id="success_message" style="font-size: 16px; display: none;">Yayy! Payment confirmed</p>

                    <p class="text-center" id="network">
                        Crypto: {{transaction_details.crypto_network}} 
                        <a href="{% url 'select_transaction_crypto' transaction_details.transaction_id %}" >change crypto?</a>
                    </p>                 

                    <p class="text-center" id="wallet" style="font-size: 12px;">{{transaction_details.wallet}}</p>

                    <p class="text-center" id="transaction_amount" style="font-size: 12px; display: none;"></p>

                    <p class="text-center" id="transaction_hash" style="font-size: 12px; display: none;"></p>

                    <p class="text-center" id="transaction_confirmed" style="font-size: 12px; display: none;"></p>

                    <div class="space16"></div>

                    <hr>

                    <p class="text-center" id="success_message" style="font-size: 16px;">powered by <a href="bitwade.com" target="_blank">bitwade.com</a></p>

                </div>

                <!-- <div class="space16"></div>

                <div class="text-center" id="items_to_remove">
                    <a href="#" id="items_to_remove" style="font-size: 12px; background: #cc1313; color: #fff; padding: 10px; border-radius: 5px; margin: 5px;" onclick="return confirm('Are you sure you want to delete this link?');">cancel transaction</a>
                </div> -->

                <script>

                    const QrCodeImage = document.getElementById('wallet_qrcode_image');
                    const successImage = document.getElementById('success_image');
                    const transactionAmount = document.getElementById('transaction_amount');
                    const transactionHash = document.getElementById('transaction_hash');
                    const transactionConfirmed = document.getElementById('transaction_confirmed');
                    const loadingImage = document.getElementById('items_to_remove');

                    const successMessage = document.getElementById('success_message');

                    const txNetwork = document.getElementById('network');
                    const txWallet = document.getElementById('wallet');
                    const txAmount = document.getElementById('amount');
                
                    function getTransactionDetails() {
                        fetch('/blockchain_api/{{transaction_details.transaction_id}}')
                            // .then(response => response.json())
                            .then(response => {
                                console.log('Response:', response);
                                return response.json();
                            })
                            .then(data => {
                                console.log('Data:', data);
                                if (data.confirmed === true) {
                                    // Update the transaction details on the page
                                    QrCodeImage.style.display = 'none';
                                    successImage.style.display = 'block';
                                    transactionAmount.style.display = 'block';
                                    transactionConfirmed.style.display = 'block';
                                    loadingImage.style.display = 'none';
                                    transactionAmount.textContent = 'Amount: ' + data.amount / 1000000 + ' TRX';

                                    txNetwork.style.display = 'none';
                                    txWallet.style.display = 'none';
                                    txAmount.style.display = 'none';

                                    successMessage.style.display = 'block';
                                    successMessage.textContent = 'Transaction was successful!';
                                }

                                // Call the function again after a delay of 5 seconds
                                setTimeout(getTransactionDetails, 5000);
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                setTimeout(getTransactionDetails, 5000);
                            });
                    }
                
                    // Start checking for the transaction
                    getTransactionDetails();

                </script>
                
            </div>
        </div>
    </div>
</div>
<!--===== WELCOME ENDS =======-->


{% endblock %}